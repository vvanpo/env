#!/usr/bin/env bash

# Installs dot-files and other initialization/configuration scripts/files into
# various places in the home directory.
# Depends on NAME, REPO, and PREFIX environment variables.

src=${PREFIX}/src/${REPO}
etc=${PREFIX}/etc/${NAME}
lib=${PREFIX}/lib/${NAME}

. "${src}/config.bash"

function install-file {
	if [[ -e $2 ]] && [[ ! -d $2 ]]; then
		rm -f "$2"
	elif [[ ${2%%/} != $2 ]]; then
		mkdir -p "$2"
	else
		mkdir -p "$(dirname "$2")"
	fi

	(set -x; cp "$1" "$2")
}

function install-url {(
	cd "$2"

	local cmd="$(eval "echo $1")"
	echo "+ curl -fsSLO $cmd"
	curl -fsSLO "$cmd"
)}

# Takes an include section name and a path to install them in.
# Prints the list of installed paths.
function install-includes {(
	# Non-absolute paths are relative to the repository.
	cd "$src"

	IFS=$'\n' read -a files -d '' <<< "$(config --get-all "includes.$1.file")"
	for file in "${files[@]}"; do
		install-file "$file" "$2/"
		echo "$2/$(basename "$file")"
	done

	IFS=$'\n' read -a urls -d '' <<< "$(config --get-all "includes.$1.url")"
	for url in "${urls[@]}"; do
		install-url "$url" "$2/"
		echo "$2/$(basename "$url")"
	done
)}

function install-git {
	rm -f ~/.gitconfig
	git config --global --add user.name "$(config --get user.name)"
	git config --global --add user.email "$(config --get user.email)"
	git config --global --add core.excludesfile "${etc}/gitignore"
}

function install-bash {
	# Include scripts need knowledge of the folder hierarchy.
	local var
	for var in NAME REPO PREFIX; do
		echo "readonly ${var}=${!var}" >> ~/.bashrc
	done
	echo -e 'export NAME REPO PREFIX\n' >> ~/.bashrc

	# config.bash is always included.
	(cd $src; install-file "config.bash" "$lib/")

	# Install include scripts and source them.
	install-includes bash "$lib" | {
		IFS=$'\n' read -a paths -d ''
		for path in "${paths[@]}"; do
			echo ". $paths" >> ~/.bashrc
		done
	}
}

request-config 'user.name' 'Full name'
request-config 'user.email' 'E-mail'

install-includes '~' ~ > /dev/null
install-includes etc "$etc" > /dev/null
install-bash
install-git
